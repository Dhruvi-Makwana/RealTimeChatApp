{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

        <title>chat_app</title>
    </head>
    <body>
        <h1 id="error_messgae"></h1>
        <div class="container">
            <h1>let's chat</h1>
            <div id="messages" class="row"></div>
            <form id="form" class="footer">
                <input type="text" name="message" />
                <input type="submit" value="submit" />
            </form>
        </div>
        <a href="{% url 'logout'%}">Logout</a>
    </body>
</html>


<script type="text/javascript">
    let url = `ws://${window.location.host}/ws/socket-server/`;
    function showMessage(message) {
    
        let messages = document.getElementById('messages')
        messages.insertAdjacentHTML('beforeend', `<div class="row bg-light"><p class="col-2">${message}</p><span class="col"><img src= {{ request.user.profile.url}} height="30px" width="40px" class="rounded-3"</div>
            </span>`);
    }
    
    const chatSocket = new WebSocket(url)
    const chatData = 'chat_message'
    chatSocket.onmessage = function(e) {
        let data = JSON.parse(e.data)
        if (data.type === chatData) {
            showMessage(data.message)
        }
    }
  
    chatSocket.onerror = function(e) {
            let error_messages = document.getElementById('error_messgae')
            error_messages.innerHTML = "Please log in to chat."
    }
    
    let form = document.getElementById('form')
    form.addEventListener('submit', (e) => {
        e.preventDefault()
        let message = e.target.message.value
        chatSocket.send(JSON.stringify({
            'message': message
        }))
    
        form.reset()
    })

</script>
</body>
</html>
